# Milk & Co – JW Marriott (khu spa) — System Context Diagram & Luồng tích hợp

## Bối cảnh
- Nhà hàng nhỏ (~40 chỗ), nằm trong khu spa của khách sạn.
- Hệ thống cần đảm bảo 3 trụ cột: **Order – Payment – Inventory**.
- Cần thể hiện các tích hợp: **Payment Gateway / Room Charge (PMS) / Printer**.

## 1) System Context Diagram (dạng text)

```
                         +----------------------+
                         |  Khách (spa/khách sạn)|
                         +----------+-----------+
                                    |
                                    | gọi món / yêu cầu thanh toán
                                    v
+--------------------+     +--------+---------+
|  Nhân viên phục vụ | --> |  Thiết bị POS    |
|  (waiter/cashier)  |     | (tablet/PC)      |
+--------------------+     +--------+---------+
                                    |
                                    | API/UI
                                    v
                       +------------+-------------+
                       |   RMS/POS Core System    |
                       |  - Order Mgmt            |
                       |  - Payment Orchestration |
                       |  - Inventory Mgmt        |
                       |  - Audit/Reports         |
                       +----+-----------+----+----+
                            |           |    |
          thanh toán thẻ/QR |           |    | in ấn
                            |           |    |
                            v           v    v
                 +----------------+  +---------------------+  +----------------------+
                 | Payment Gateway|  | PMS (Hotel System)  |  | Print Service/Printer |
                 | (card/QR/acq.) |  | (Room charge/folio) |  | - Kitchen ticket      |
                 +----------------+  +---------------------+  | - Receipt/Invoice     |
                                                             +----------------------+
```

## 2) Luồng tích hợp Payment (thẻ/QR)

```
(1) POS -> RMS: Tạo yêu cầu thanh toán (order_id, amount, idempotency_key)
(2) RMS -> Payment Gateway: Payment Request
(3) Gateway -> RMS: Kết quả (PAID / FAILED / PENDING)
(4) (Tuỳ chọn) Gateway -> RMS: Webhook xác nhận kết quả cuối
(5) RMS -> POS: Cập nhật trạng thái Order
(6) RMS -> Printer: In biên lai/hóa đơn
(7) RMS -> Inventory: Ghi nhận tiêu hao nguyên liệu theo món
```

**Ghi chú tối thiểu:** dùng `idempotency_key` để tránh nhân viên bấm “Pay” nhiều lần tạo giao dịch trùng.

## 3) Luồng tích hợp Room Charge (ghi nợ phòng qua PMS)

```
(1) POS -> RMS: Chọn Room Charge + nhập room/guest/folio
(2) RMS -> PMS: Post Charge (order_id, amount, outlet_code, reference)
(3) PMS -> RMS: APPROVED (posting_id/folio_ref) hoặc DECLINED (reason)
(4) RMS -> POS: Order = ROOM_CHARGED (nếu approved) hoặc quay lại chọn phương thức khác
(5) RMS -> Printer: In hóa đơn/phiếu ký (nếu yêu cầu)
(6) RMS -> Inventory: Ghi nhận tiêu hao nguyên liệu theo món
```

## 4) Luồng tích hợp Printer (phiếu bếp + hóa đơn)

### 4.1 In phiếu bếp (khi xác nhận Order)
```
(1) POS -> RMS: Confirm Order
(2) RMS -> Kitchen Printer: In phiếu bếp (món, số lượng, ghi chú)
```

### 4.2 In hóa đơn/biên lai (khi Payment/Room Charge thành công)
```
(1) RMS nhận trạng thái PAID / ROOM_CHARGED
(2) RMS -> Receipt/Invoice Printer: In hóa đơn/biên lai
```

## 5) Điểm chạm Inventory (tối thiểu)

```
- Khi Confirm Order: trừ kho theo định mức món
- Khi Hủy/Hoàn món: hoàn kho theo rule
- Luôn lưu sổ kho (ledger) để audit
```
